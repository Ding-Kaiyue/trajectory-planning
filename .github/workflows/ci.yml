name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  ROS_DISTRO: humble

jobs:
  test:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        config:
          - {name: "Default Build", use_trac_ik: "ON"}
          - {name: "Without TracIK", use_trac_ik: "OFF"}

    name: ${{ matrix.config.name }}

    steps:
    - uses: actions/checkout@v4

    - name: Setup ROS 2
      uses: ros-tooling/setup-ros@v0.7
      with:
        required-ros-distributions: ${{ env.ROS_DISTRO }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-vcstool \
          python3-colcon-common-extensions \
          python3-rosdep

    - name: Initialize rosdep
      run: |
        sudo rosdep init || true
        rosdep update

    - name: Create workspace
      run: |
        mkdir -p ~/ros_ws/src
        cd ~/ros_ws/src
        ln -s $GITHUB_WORKSPACE ./trajectory_planning

    - name: Install MoveIt2 dependencies
      run: |
        cd ~/ros_ws
        # 使用预编译的MoveIt2包而不是从源码构建
        sudo apt-get install -y \
          ros-${{ env.ROS_DISTRO }}-moveit-core \
          ros-${{ env.ROS_DISTRO }}-moveit-planners \
          ros-${{ env.ROS_DISTRO }}-moveit-plugins

    - name: Install TracIK (if enabled)
      if: matrix.config.use_trac_ik == 'ON'
      run: |
        cd ~/ros_ws/src
        # Clone the original trac_ik for ROS1 (used as reference)
        git clone https://github.com/aprotyas/trac_ik.git
        # Note: Your ROS2 adaptation plugin is already in the project src

    - name: Create mock hardware_driver package for CI
      run: |
        cd ~/ros_ws/src
        mkdir -p mock_hardware_driver
        cd mock_hardware_driver

        # 创建最小的 package.xml
        cat > package.xml << 'EOF'
        <?xml version="1.0"?>
        <package format="3">
          <name>hardware_driver</name>
          <version>0.0.0</version>
          <description>Mock hardware_driver package for CI</description>
          <maintainer email="ci@example.com">CI</maintainer>
          <license>MIT</license>
          <buildtool_depend>ament_cmake</buildtool_depend>
          <export><build_type>ament_cmake</build_type></export>
        </package>
        EOF

        # 创建最小的 CMakeLists.txt
        cat > CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.8)
        project(hardware_driver)
        find_package(ament_cmake REQUIRED)

        # 安装头文件
        install(DIRECTORY include/ DESTINATION include/)

        ament_package()
        EOF

        # 创建mock头文件结构
        mkdir -p include/hardware_driver/interface
        cat > include/hardware_driver/interface/robot_hardware.hpp << 'EOF'
        #pragma once
        #include <vector>
        #include <string>
        #include <memory>

        namespace hardware_driver {

        // Mock轨迹类型
        struct Trajectory {
            struct Point {
                std::vector<double> positions;
                std::vector<double> velocities;
                std::vector<double> accelerations;
                double time_from_start;
            };
            std::vector<Point> points;
        };

        // Mock RobotHardware类
        class RobotHardware {
        public:
            RobotHardware() = default;
            virtual ~RobotHardware() = default;

            // Mock方法 - 仅为编译通过
            virtual bool initialize() { return true; }
            virtual bool isConnected() { return false; }
            virtual void executeTrajectory(const Trajectory&) {}
        };

        } // namespace hardware_driver
        EOF

    - name: Install project dependencies
      run: |
        cd ~/ros_ws
        rosdep install --from-paths src --ignore-src -r -y --skip-keys="warehouse_ros_mongo ruckig" || true

    - name: Build workspace
      run: |
        cd ~/ros_ws
        source /opt/ros/${{ env.ROS_DISTRO }}/setup.bash

        # 检查工作空间结构
        echo "=== 工作空间结构 ==="
        find src -name "package.xml" | head -10

        # 首先构建依赖包（包含mock hardware_driver）
        echo "=== 构建依赖包 ==="
        colcon build \
          --packages-select robot_interfaces hardware_driver \
          --cmake-args \
            -DCMAKE_BUILD_TYPE=Release \
          --event-handlers console_direct+

        # 检查构建结果
        if [ $? -ne 0 ]; then
          echo "ERROR: 依赖包构建失败"
          exit 1
        fi

        # source 依赖包环境
        source install/setup.bash

        # 然后构建主包（使用mock hardware_driver）
        echo "=== 构建 trajectory_planning_v3 ==="
        colcon build \
          --packages-select trajectory_planning_v3 \
          --cmake-args \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_TRAC_IK=${{ matrix.config.use_trac_ik }} \
          --event-handlers console_direct+

    - name: Run tests
      run: |
        cd ~/ros_ws
        source /opt/ros/${{ env.ROS_DISTRO }}/setup.bash
        source install/setup.bash

        # 运行 ament 测试
        colcon test --packages-select trajectory_planning_v3

        # 显示测试结果
        colcon test-result --verbose

    - name: Lint and format check
      run: |
        cd ~/ros_ws
        source /opt/ros/${{ env.ROS_DISTRO }}/setup.bash
        source install/setup.bash

        # 运行 lint 检查
        ament_cpplint src/trajectory_planning/src/trajectory_planning_v3/ || true
        ament_cppcheck src/trajectory_planning/src/trajectory_planning_v3/ || true

  build-check:
    runs-on: ubuntu-22.04
    name: Build Check (Fast)

    steps:
    - uses: actions/checkout@v4

    - name: Setup ROS 2
      uses: ros-tooling/setup-ros@v0.7
      with:
        required-ros-distributions: ${{ env.ROS_DISTRO }}

    - name: Install minimal dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-colcon-common-extensions \
          python3-rosdep \
          ros-${{ env.ROS_DISTRO }}-moveit \
          ros-${{ env.ROS_DISTRO }}-moveit-resources \
          ros-${{ env.ROS_DISTRO }}-ruckig || true

    - name: Initialize rosdep
      run: |
        sudo rosdep init || true
        rosdep update

    - name: Create workspace and install dependencies
      run: |
        mkdir -p ~/ros_ws/src
        cd ~/ros_ws/src
        ln -s $GITHUB_WORKSPACE ./trajectory_planning
        git clone https://github.com/Ding-Kaiyue/hardware-driver.git
        cd ~/ros_ws
        rosdep install --from-paths src --ignore-src -r -y --skip-keys="warehouse_ros_mongo ruckig"

    - name: Fast build check
      run: |
        cd ~/ros_ws
        source /opt/ros/${{ env.ROS_DISTRO }}/setup.bash

        # 创建mock hardware_driver (重复逻辑)
        mkdir -p src/mock_hardware_driver
        cd src/mock_hardware_driver
        cat > package.xml << 'EOF'
        <?xml version="1.0"?>
        <package format="3">
          <name>hardware_driver</name>
          <version>0.0.0</version>
          <description>Mock hardware_driver package for CI</description>
          <maintainer email="ci@example.com">CI</maintainer>
          <license>MIT</license>
          <buildtool_depend>ament_cmake</buildtool_depend>
          <export><build_type>ament_cmake</build_type></export>
        </package>
        EOF
        cat > CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.8)
        project(hardware_driver)
        find_package(ament_cmake REQUIRED)
        install(DIRECTORY include/ DESTINATION include/)
        ament_package()
        EOF

        # 创建同样的mock头文件
        mkdir -p include/hardware_driver/interface
        cat > include/hardware_driver/interface/robot_hardware.hpp << 'EOF'
        #pragma once
        #include <vector>
        #include <string>
        #include <memory>

        namespace hardware_driver {
        struct Trajectory {
            struct Point {
                std::vector<double> positions;
                std::vector<double> velocities;
                std::vector<double> accelerations;
                double time_from_start;
            };
            std::vector<Point> points;
        };
        class RobotHardware {
        public:
            RobotHardware() = default;
            virtual ~RobotHardware() = default;
            virtual bool initialize() { return true; }
            virtual bool isConnected() { return false; }
            virtual void executeTrajectory(const Trajectory&) {}
        };
        } // namespace hardware_driver
        EOF
        cd ~/ros_ws

        # 构建依赖包（包含mock hardware_driver）
        colcon build \
          --packages-select robot_interfaces hardware_driver \
          --cmake-args \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF \
          --event-handlers console_direct+

        # source 依赖包环境
        source install/setup.bash

        # 快速构建检查（不编译测试）
        colcon build \
          --packages-select trajectory_planning_v3 \
          --cmake-args \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF \
          --event-handlers console_direct+

  analyze:
    runs-on: ubuntu-22.04
    name: Static Analysis

    steps:
    - uses: actions/checkout@v4

    - name: Skip clang-format check
      run: |
        echo "代码格式检查已禁用 - 格式规范仅作为参考标准"
        echo "开发者可选择使用 'clang-format -i <file>' 格式化代码"

    # 注释掉严格的格式检查
    # - name: Run clang-format check
    #   uses: jidicula/clang-format-action@v4.11.0
    #   with:
    #     clang-format-version: '14'
    #     check-path: 'src'

    - name: Setup ROS 2 for analysis
      uses: ros-tooling/setup-ros@v0.7
      with:
        required-ros-distributions: ${{ env.ROS_DISTRO }}

    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cppcheck \
          clang-tidy \
          python3-colcon-common-extensions

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --suppress=missingIncludeSystem \
          --xml --xml-version=2 \
          src/trajectory_planning_v3/src/ \
          src/trajectory_planning_v3/include/ \
          2> cppcheck-result.xml || true

    - name: Upload cppcheck results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cppcheck-results
        path: cppcheck-result.xml