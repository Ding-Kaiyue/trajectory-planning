name: Code Quality

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´ä»£ç è´¨é‡æ£€æŸ¥
    - cron: '0 2 * * 1'

jobs:
  format-check:
    runs-on: ubuntu-22.04
    name: Code Format Check

    steps:
    - uses: actions/checkout@v4

    - name: Run clang-format
      uses: jidicula/clang-format-action@v4.11.0
      with:
        clang-format-version: '14'
        check-path: 'src'
        fallback-style: 'Google'
        exclude-regex: '^src/.*/(build|install|log)/.*'

    - name: Check CMake format
      run: |
        # æ£€æŸ¥CMakeLists.txtæ ¼å¼
        find . -name "CMakeLists.txt" -not -path "./build/*" -not -path "./install/*" | while read file; do
          echo "Checking CMake format: $file"
          # åŸºæœ¬æ ¼å¼æ£€æŸ¥
          if grep -q $'\t' "$file"; then
            echo "Warning: Found tabs in $file, prefer spaces"
          fi
        done

  static-analysis:
    runs-on: ubuntu-22.04
    name: Static Analysis

    steps:
    - uses: actions/checkout@v4

    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cppcheck \
          clang-tidy \
          python3-pip

        # å®‰è£…å…¶ä»–åˆ†æå·¥å…·
        pip3 install lizard  # ä»£ç å¤æ‚åº¦åˆ†æ

    - name: Run cppcheck
      run: |
        cppcheck \
          --enable=all \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=unmatchedSuppression \
          --inline-suppr \
          --xml \
          --xml-version=2 \
          --output-file=cppcheck-result.xml \
          src/trajectory_planning_v3/src/ \
          src/trajectory_planning_v3/include/ || true

        # æ˜¾ç¤ºç»“æœæ‘˜è¦
        if [ -f cppcheck-result.xml ]; then
          echo "=== CPPCheck ç»“æœæ‘˜è¦ ==="
          grep -c "error\|warning\|style\|performance\|portability" cppcheck-result.xml || echo "æ— é—®é¢˜å‘ç°"
        fi

    - name: Run lizard complexity analysis
      run: |
        echo "=== ä»£ç å¤æ‚åº¦åˆ†æ ==="
        lizard src/trajectory_planning_v3/src/ -l cpp --csv > complexity-report.csv || true

        # æ˜¾ç¤ºå¤æ‚åº¦æœ€é«˜çš„å‡½æ•°
        echo "=== å¤æ‚åº¦æœ€é«˜çš„10ä¸ªå‡½æ•° ==="
        lizard src/trajectory_planning_v3/src/ -l cpp -s cyclomatic_complexity | head -20 || true

    - name: Check for TODO/FIXME
      run: |
        echo "=== å¾…åŠäº‹é¡¹æ£€æŸ¥ ==="
        grep -r -n --include="*.cpp" --include="*.hpp" --include="*.h" \
          -E "(TODO|FIXME|HACK|XXX)" \
          src/trajectory_planning_v3/ || echo "æ— å¾…åŠäº‹é¡¹"

    - name: Upload analysis results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: static-analysis-results
        path: |
          cppcheck-result.xml
          complexity-report.csv

  dependency-check:
    runs-on: ubuntu-22.04
    name: Dependency Analysis

    steps:
    - uses: actions/checkout@v4

    - name: Setup ROS 2
      uses: ros-tooling/setup-ros@v0.7
      with:
        required-ros-distributions: humble

    - name: Analyze dependencies
      run: |
        echo "=== ROS2 åŒ…ä¾èµ–åˆ†æ ==="

        # æ£€æŸ¥package.xmlä¾èµ–
        echo "Package.xml ä¾èµ–ï¼š"
        if [ -f src/trajectory_planning_v3/package.xml ]; then
          grep -E "<depend>|<build_depend>|<exec_depend>" src/trajectory_planning_v3/package.xml || true
        fi

        echo ""
        echo "=== CMake ä¾èµ–åˆ†æ ==="
        # æ£€æŸ¥CMakeLists.txtä¾èµ–
        if [ -f src/trajectory_planning_v3/CMakeLists.txt ]; then
          echo "CMakeLists.txt find_package è°ƒç”¨ï¼š"
          grep "find_package" src/trajectory_planning_v3/CMakeLists.txt || true
        fi

    - name: Check for security issues
      run: |
        echo "=== å®‰å…¨æ£€æŸ¥ ==="

        # æ£€æŸ¥ç¡¬ç¼–ç å¯†ç æˆ–æ•æ„Ÿä¿¡æ¯
        echo "æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
        grep -r -i --include="*.cpp" --include="*.hpp" --include="*.h" \
          -E "(password|secret|key|token)" \
          src/trajectory_planning_v3/ || echo "æœªå‘ç°æ•æ„Ÿä¿¡æ¯"

        # æ£€æŸ¥ä¸å®‰å…¨çš„å‡½æ•°è°ƒç”¨
        echo ""
        echo "æ£€æŸ¥ä¸å®‰å…¨å‡½æ•°è°ƒç”¨..."
        grep -r --include="*.cpp" --include="*.hpp" --include="*.h" \
          -E "(strcpy|strcat|sprintf|gets)" \
          src/trajectory_planning_v3/ || echo "æœªå‘ç°ä¸å®‰å…¨å‡½æ•°è°ƒç”¨"

  documentation-check:
    runs-on: ubuntu-22.04
    name: Documentation Check

    steps:
    - uses: actions/checkout@v4

    - name: Check documentation coverage
      run: |
        echo "=== æ–‡æ¡£è¦†ç›–ç‡æ£€æŸ¥ ==="

        # æ£€æŸ¥å¤´æ–‡ä»¶æ³¨é‡Šè¦†ç›–ç‡
        HEADER_FILES=$(find src/trajectory_planning_v3/include -name "*.hpp" -o -name "*.h" | wc -l)
        DOCUMENTED_HEADERS=$(grep -l -r "@brief\|@param\|@return\|/\*\*" src/trajectory_planning_v3/include || true | wc -l)

        echo "å¤´æ–‡ä»¶æ€»æ•°: $HEADER_FILES"
        echo "æœ‰æ–‡æ¡£çš„å¤´æ–‡ä»¶: $DOCUMENTED_HEADERS"

        if [ $HEADER_FILES -gt 0 ]; then
          COVERAGE=$((DOCUMENTED_HEADERS * 100 / HEADER_FILES))
          echo "æ–‡æ¡£è¦†ç›–ç‡: $COVERAGE%"

          if [ $COVERAGE -lt 50 ]; then
            echo "âš ï¸ è­¦å‘Š: æ–‡æ¡£è¦†ç›–ç‡ä½äº50%"
          fi
        fi

    - name: Check README completeness
      run: |
        echo "=== README å®Œæ•´æ€§æ£€æŸ¥ ==="

        required_sections=("å®‰è£…" "ä½¿ç”¨" "API" "è®¸å¯è¯")
        for section in "${required_sections[@]}"; do
          if grep -qi "$section" README.md; then
            echo "âœ… æ‰¾åˆ° $section éƒ¨åˆ†"
          else
            echo "âŒ ç¼ºå°‘ $section éƒ¨åˆ†"
          fi
        done

  performance-check:
    runs-on: ubuntu-22.04
    name: Performance Analysis

    steps:
    - uses: actions/checkout@v4

    - name: Analyze code metrics
      run: |
        echo "=== ä»£ç æŒ‡æ ‡åˆ†æ ==="

        # ä»£ç è¡Œæ•°ç»Ÿè®¡
        echo "æºç ç»Ÿè®¡:"
        find src/trajectory_planning_v3 -name "*.cpp" -o -name "*.hpp" | xargs wc -l | tail -1

        echo ""
        echo "å¤´æ–‡ä»¶ç»Ÿè®¡:"
        find src/trajectory_planning_v3/include -name "*.hpp" -o -name "*.h" | xargs wc -l | tail -1

        # æ£€æŸ¥å¤§æ–‡ä»¶
        echo ""
        echo "=== å¤§æ–‡ä»¶æ£€æŸ¥ (>500è¡Œ) ==="
        find src/trajectory_planning_v3 -name "*.cpp" -o -name "*.hpp" | while read file; do
          lines=$(wc -l < "$file")
          if [ $lines -gt 500 ]; then
            echo "$file: $lines è¡Œ"
          fi
        done

        # æ£€æŸ¥é•¿å‡½æ•°
        echo ""
        echo "=== é•¿å‡½æ•°æ£€æŸ¥ ==="
        pip3 install lizard > /dev/null 2>&1
        lizard src/trajectory_planning_v3 -l cpp -T nloc=50 || true

  summary:
    needs: [format-check, static-analysis, dependency-check, documentation-check, performance-check]
    runs-on: ubuntu-22.04
    name: Quality Summary
    if: always()

    steps:
    - name: Generate quality report
      run: |
        echo "# ğŸ” ä»£ç è´¨é‡æŠ¥å‘Š" > quality-report.md
        echo "" >> quality-report.md
        echo "## ğŸ“Š æ£€æŸ¥ç»“æœ" >> quality-report.md
        echo "" >> quality-report.md

        # æ£€æŸ¥å„ä¸ªjobçš„çŠ¶æ€
        if [ "${{ needs.format-check.result }}" == "success" ]; then
          echo "- âœ… ä»£ç æ ¼å¼æ£€æŸ¥: é€šè¿‡" >> quality-report.md
        else
          echo "- âŒ ä»£ç æ ¼å¼æ£€æŸ¥: å¤±è´¥" >> quality-report.md
        fi

        if [ "${{ needs.static-analysis.result }}" == "success" ]; then
          echo "- âœ… é™æ€åˆ†æ: é€šè¿‡" >> quality-report.md
        else
          echo "- âŒ é™æ€åˆ†æ: å¤±è´¥" >> quality-report.md
        fi

        if [ "${{ needs.dependency-check.result }}" == "success" ]; then
          echo "- âœ… ä¾èµ–æ£€æŸ¥: é€šè¿‡" >> quality-report.md
        else
          echo "- âŒ ä¾èµ–æ£€æŸ¥: å¤±è´¥" >> quality-report.md
        fi

        if [ "${{ needs.documentation-check.result }}" == "success" ]; then
          echo "- âœ… æ–‡æ¡£æ£€æŸ¥: é€šè¿‡" >> quality-report.md
        else
          echo "- âŒ æ–‡æ¡£æ£€æŸ¥: å¤±è´¥" >> quality-report.md
        fi

        if [ "${{ needs.performance-check.result }}" == "success" ]; then
          echo "- âœ… æ€§èƒ½åˆ†æ: é€šè¿‡" >> quality-report.md
        else
          echo "- âŒ æ€§èƒ½åˆ†æ: å¤±è´¥" >> quality-report.md
        fi

        echo "" >> quality-report.md
        echo "## ğŸ“ˆ æ”¹è¿›å»ºè®®" >> quality-report.md
        echo "" >> quality-report.md
        echo "- ä¿æŒä»£ç æ ¼å¼ä¸€è‡´æ€§" >> quality-report.md
        echo "- å¢åŠ ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£" >> quality-report.md
        echo "- å®šæœŸè¿è¡Œé™æ€åˆ†æå·¥å…·" >> quality-report.md
        echo "- æ§åˆ¶å‡½æ•°å’Œç±»çš„å¤æ‚åº¦" >> quality-report.md

        cat quality-report.md

    - name: Upload quality report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quality-report
        path: quality-report.md